name: CI
on: { push: { branches: [ master ] }, pull_request: {} }

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      db:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpass
          POSTGRES_DB: testdb
        ports: ['55432:5432']
        options: >-
          --health-cmd="pg_isready -U testuser -d testdb"
          --health-interval=5s --health-timeout=5s --health-retries=20

      redis:
        image: redis:7-alpine
        ports: ['6379:6379']
        options: >-
          --health-cmd="redis-cli ping"
          --health-interval=5s --health-timeout=5s --health-retries=20

    env:
      TEST: 'True'

      POSTGRES_DB: testdb
      POSTGRES_USER: testuser
      POSTGRES_PASSWORD: testpass
      DB_HOST: localhost
      DB_PORT: '55432'

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: '3.13' }
      - run: pip install -r requirements-dev.txt

      - name: Migrate
        run: python manage.py migrate --noinput

      - name: Tests
        run: pytest -q